<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Local Share</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Local Share</h1>
        <form id="upload-form" method="POST" action="/upload" enctype="multipart/form-data">
            <input type="file" name="file">
            <button type="submit">Upload</button>
        </form>
        <progress id="progress-bar" value="0" max="100" style="width: 100%; display: none;"></progress>
        <p id="upload-info" style="display: none;">
            Speed: <span id="upload-speed">0 MB/s</span><br>
            Estimated time: <span id="estimated-time">0 seconds</span>
        </p>
        <h2>Recent Files (Last 24 Hours)</h2>
        {% if files %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Uploaded</th>
                            <th>File Size</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                            <tr>
                                <td class="filename">{{ file.original_name }}</td>
                                <td>{{ file.upload_time.strftime('%b %d, %Y, %I:%M %p') }}</td>
                                <td>{{ file.display_size }}</td>
                                <td>
                                    <a href="{{ url_for('download_file', file_id=file.id) }}" class="button download-btn">Download</a>
                                    {% if file.extension in streamable_extensions %}
                                        <a href="{{ url_for('stream_page', file_id=file.id) }}" class="button stream-btn">Stream</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No files uploaded in the last 24 hours.</p>
        {% endif %}
        <footer>
            <p>Files are automatically deleted after 24 hours.</p>
        </footer>
    </div>
    <script>
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            var fileInput = form.querySelector('input[type="file"]');
            var file = fileInput.files[0];
            if (!file) return;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', form.action, true);

            var progressBar = document.getElementById('progress-bar');
            var uploadInfo = document.getElementById('upload-info');
            var speedElem = document.getElementById('upload-speed');
            var timeElem = document.getElementById('estimated-time');

            progressBar.style.display = 'block';
            uploadInfo.style.display = 'block';

            var startTime = Date.now();

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    var percent = (event.loaded / event.total) * 100;
                    progressBar.value = percent;

                    var currentTime = Date.now();
                    var elapsed = (currentTime - startTime) / 1000; // seconds
                    if (elapsed > 0) {
                        var speed = event.loaded / elapsed; // bytes per second
                        var remainingBytes = event.total - event.loaded;
                        var estimatedTime = speed > 0 ? remainingBytes / speed : 0; // seconds

                        speedElem.textContent = (speed / 1024 / 1024).toFixed(2) + ' MB/s';
                        timeElem.textContent = estimatedTime.toFixed(0) + ' seconds';
                    }
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    location.reload();
                } else {
                    alert('Upload failed');
                    progressBar.style.display = 'none';
                    uploadInfo.style.display = 'none';
                }
            };

            xhr.onerror = function() {
                alert('Upload error');
                progressBar.style.display = 'none';
                uploadInfo.style.display = 'none';
            };

            var formData = new FormData(form);
            xhr.send(formData);
        });

        // Truncate long file names
        document.querySelectorAll('.filename').forEach(function(element) {
            var text = element.textContent;
            if (text.length > 30) {
                var start = text.slice(0, 15);
                var extIndex = text.lastIndexOf('.');
                var end = text.slice(extIndex - 10, extIndex) + text.slice(extIndex);
                element.textContent = start + '.....' + end;
            }
        });
    </script>
</body>
</html>