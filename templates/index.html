<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalShare</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>LocalShare</h1>

        <!-- Folder Mode Checkbox - Moved outside drop area -->
        <p style="margin-bottom: 10px;">
            <label><input type="checkbox" id="folder-mode"> Enable folder upload (select entire directory)</label>
        </p>

        <!-- Drag-and-Drop Area -->
        <div id="drop-area" style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px;">
            <p>Drag & drop files or a folder here, or click to select</p>
            <form id="upload-form" method="POST" action="/upload" enctype="multipart/form-data">
                <input type="file" name="file" multiple id="file-input" style="display: none;">
            </form>
        </div>

        <progress id="progress-bar" value="0" max="100" style="width: 100%; display: none;"></progress>
        <p id="upload-info" style="display: none;">
            Speed: <span id="upload-speed">0 MB/s</span><br>
            Estimated time: <span id="estimated-time">0 seconds</span>
        </p>

        <h2>Recent Files (Last 24 Hours)</h2>
        {% if files %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Uploaded</th>
                            <th>File Size</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                            <tr>
                                <td class="filename">{{ file.original_name }}</td>
                                <td>{{ file.upload_time.strftime('%b %d, %Y, %I:%M %p') }}</td>
                                <td>{{ file.display_size }}</td>
                                <td>
                                    <a href="{{ url_for('download_file', file_id=file.id) }}" class="button download-btn">Download</a>
                                    {% if file.extension in streamable_extensions %}
                                        <a href="{{ url_for('stream_page', file_id=file.id) }}" class="button stream-btn">Stream</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No files uploaded in the last 24 hours.</p>
        {% endif %}
        <footer>
            <p>Files are automatically deleted after 24 hours.</p>
        </footer>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const uploadForm = document.getElementById('upload-form');
        const folderModeCheckbox = document.getElementById('folder-mode');

        // Toggle folder mode
        folderModeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                fileInput.setAttribute('webkitdirectory', '');
                fileInput.setAttribute('directory', '');
                dropArea.querySelector('p').textContent = 'Drag & drop files or a folder here, or click to select folder';
            } else {
                fileInput.removeAttribute('webkitdirectory');
                fileInput.removeAttribute('directory');
                dropArea.querySelector('p').textContent = 'Drag & drop files or a folder here, or click to select files';
            }
        });

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop area
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.borderColor = '#007bff', false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.borderColor = '#ccc', false);
        });

        // Handle drop
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                startUpload();
            }
        }

        // Click only triggers file picker (checkbox is outside, so no conflict)
        dropArea.addEventListener('click', () => fileInput.click());

        // Start upload function
        function startUpload() {
            const files = fileInput.files;
            if (files.length === 0) return;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            const progressBar = document.getElementById('progress-bar');
            const uploadInfo = document.getElementById('upload-info');
            const speedElem = document.getElementById('upload-speed');
            const timeElem = document.getElementById('estimated-time');

            progressBar.style.display = 'block';
            uploadInfo.style.display = 'block';
            progressBar.value = 0;
            speedElem.textContent = '0 MB/s';
            timeElem.textContent = 'Calculating...';

            let lastLoaded = 0;
            let lastTime = Date.now();

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const currentTime = Date.now();
                    const timeDiff = (currentTime - lastTime) / 1000 || 0.001;
                    const loadedDiff = event.loaded - lastLoaded;

                    const speed = loadedDiff / timeDiff / 1024 / 1024;
                    speedElem.textContent = speed.toFixed(2) + ' MB/s';

                    progressBar.value = (event.loaded / event.total) * 100;

                    const remaining = event.total - event.loaded;
                    const eta = speed > 0 ? remaining / (speed * 1024 * 1024) : 0;
                    timeElem.textContent = eta.toFixed(0) + ' seconds';

                    lastLoaded = event.loaded;
                    lastTime = currentTime;
                }
            };

            xhr.onload = function() {
                progressBar.style.display = 'none';
                uploadInfo.style.display = 'none';
                if (xhr.status === 200) {
                    location.reload();
                } else {
                    alert('Upload failed: ' + xhr.status);
                }
            };

            xhr.onerror = function() {
                alert('Upload error');
                progressBar.style.display = 'none';
                uploadInfo.style.display = 'none';
            };

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const path = file.webkitRelativePath || file.name;
                formData.append('file', file, path);
            }

            xhr.send(formData);
        }

        // Handle file picker change
        fileInput.addEventListener('change', startUpload);

        // Truncate long file names
        document.querySelectorAll('.filename').forEach(function(element) {
            var text = element.textContent;
            if (text.length > 30) {
                var start = text.slice(0, 15);
                var extIndex = text.lastIndexOf('.');
                var end = text.slice(extIndex - 10 < 0 ? 0 : extIndex - 10, extIndex) + text.slice(extIndex);
                element.textContent = start + '.....' + end;
            }
        });
    </script>
</body>
</html>